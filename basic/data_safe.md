# 如何确保数据安全？

![pexels-anthony-170290_HMSadH](https://img.slarker.me/blog/pexels-anthony-170290_HMSadH.jpg)

当你有了 NAS，所有的数据也都由你自己掌握，但同时你也得为自己的数据多操点心，不至于在家里人把数据都存到你这台 NAS 之后，由于意外导致数据全丢，你又没法找回，那这损失可就大了。

我这里有几条经验分享给你：

- 区分清楚你的数据，哪些是重要的，哪些是不重要的，这些数据大致需要多少容量的存储空间，这个问题最好在你使用 NAS 之前就考虑清楚，方便后续建立具有相应容错等级的 raid 存储池来满足要求。
- 根据 3-2-1 原则，对重要的数据做备份，即便是已经将重要数据存到了具有容错功能的 raid 磁盘上面，这里有篇文章可以参考：[不想被勒索软件毁掉数据，就按照「3-2-1 原则」来备份文件](https://sspai.com/post/39591)。
- 设想几种可能发生的情况，比如某块磁盘坏掉，比如系统无法启动，又比如某些重要文件被误删，更极端一点，假设你的 NAS 被雷击了的时候，你能否顺利的从备份中恢复数据？

## 使用带有容错（冗余）功能的 Raid 磁盘阵列

这里推荐一个群晖的在线工具 [Raid 计算器](https://www.synology.cn/zh-cn/support/RAID_calculator)，可以直观的计算出各种 Raid 类型的冗余情况。

![ujgeyx12.1jz_iGlDXE](https://img.slarker.me/blog/ujgeyx12.1jz_iGlDXE.png)

比如，这里使用了 4 块 16TB 硬盘，如果使用 Raid5 类型，可用空间就是 43.7TB，有 14.6TB 的空间用来保护数据，4 块盘里最多同时允许坏 1 块，你的数据不会丢失。如果使用 Raid1 类型，可用空间就是 14.6TB，有 43.7TB 的空间用来保护数据，4 块盘里最多同时允许坏 3 块，你的数据不会丢失。

![yhy4bout.1tn_tufIzv](https://img.slarker.me/blog/yhy4bout.1tn_tufIzv.png)

![pv4tq3yo.njp_mzEFQ5](https://img.slarker.me/blog/pv4tq3yo.njp_mzEFQ5.png)

在 Unraid 里，能实现同样功能的是 ZFS，原理大致都一样，叫法略有不同。

## 自动备份数据

在 Unraid 上面，推荐使用开源的 Duplicati 来定期自动备份数据。不仅可以把数据备份到 NAS 上的其他磁盘里，还可以同时备份到云服务或者挂载好的网盘里。具体可以看这篇教程：[开源免费的备份方案 - Duplicati](/unraid/duplicati.md)

## 避免意外断电 - 给 NAS 配一个 UPS

机械硬盘成本在 NAS 里肯定算是大头，同时机械硬盘在 NAS 的所有部件里也是最脆弱的，异常断电对机械硬盘造成的危害不小，我见过不少因为异常断电导致硬盘损坏丢数据的用户。基于这些惨痛的教训，有必要为 NAS 配一个不间断电源，也就是 UPS。一个 UPS 也就几百块，对于 NAS 整机成本来说影响很小，却可以很大程度保障你的 NAS 安全，因此非常推荐购买。

首先需要说明一点，UPS 的存在并不是为了让你的设备能够一直持续在开机状态工作，而是为了让你的设备在市电中断后，能够有足够的时间来完成关机动作，避免意外断电对你的设备造成损坏。家用 UPS 基本上都配备了一根 USB 信号线，以便在市电中断时通知需要关机的设备。

## NAS 都支持 UPS 吗？

群晖，Unraid，或者是使用 PVE 安装的 All in one 都支持 UPS，只要购买带有 USB 接口的 UPS 就可以。

### Unraid 配置 UPS

Unraid 的 UPS 设置非常简单，把 UPS 的 USB 线接入 NAS，就可以在 `设置 -> UPS 设置` 中配置：

![2GGO8X_XyxJWn](https://img.slarker.me/blog/2GGO8X_XyxJWn.png)

### 如何让一台 UPS 支持多台设备

目前市面上的 UPS 基本只带了一根 USB 信号线，那么如果有两台设备，能否同时使用 USB 来接到 UPS 呢？一个开脑洞的想法是买一根 1 分 2 的 USB 线，把两台设备都同时接到 UPS 上，不过经过搜索后发现，已经有网友试过了，这种办法并不可行。

另一种可行的办法是看这两个 UPS 是否都支持 nut，比如群晖，Unraid 都支持，像是极空间就不支持。如果都支持的话，那就可以把其中一台（A）接到 UPS 上，并设置为 nut 网络服务器，另一台（B）作为 nut 客户端，这样等市电中断时，A 可以从 UPS 获取到断电信号，并把这个消息发送给 B，这样 A 和 B 就都可以做到正常关机。

用上面这个办法也可以做到让使用 PVE 安装的群晖虚拟机也能够使用 UPS。在逻辑上，PVE 和群晖是两台设备，可以将 USB 接口的 UPS 通过虚拟机添加到群晖里，并将群晖设置为 nut 服务器，在 PVE 里设置 nut 作为客户端，这样群晖和 PVE 就都可以正常关机，具体操作可以参考这个教程：
[PVE 群晖 连接UPS实现停电关机](https://www.purefish.cc/pve-synology-ups.html)。


