import{_ as i,c as s,a2 as a,o as t}from"./chunks/framework.eme8ZeBJ.js";const h=JSON.parse('{"title":"fnOS 虚拟 iStoreOS 软路由","description":"","frontmatter":{},"headers":[],"relativePath":"fnos/istoreos.md","filePath":"fnos/istoreos.md","lastUpdated":1737623445000}'),p={name:"fnos/istoreos.md"};function o(r,e,c,l,d,n){return t(),s("div",null,e[0]||(e[0]=[a(`<h1 id="fnos-虚拟-istoreos-软路由" tabindex="-1">fnOS 虚拟 iStoreOS 软路由 <a class="header-anchor" href="#fnos-虚拟-istoreos-软路由" aria-label="Permalink to &quot;fnOS 虚拟 iStoreOS 软路由&quot;">​</a></h1><div class="warning custom-block"><p class="custom-block-title">警告</p><p>涉及到网络，硬件直通，虚拟机等操作如果出现误操作，可能会导致系统崩溃，无法正常启动，系统连不上等各种严重问题，请谨慎评估风险后再操作！</p></div><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-54-23.webp" alt=""></p><p><img src="https://img.slarker.me/wiki/264321737518159_.pic.webp" alt=""></p><p>大家期待的虚拟机功能，飞牛在 <code>0.8.36</code> 这个版本终于支持了！而且支持了 <strong>硬件直通</strong>！下面就教大家如何在多网口的机器上使用飞牛虚拟机安装 iStoreOS 软路由。</p><ul><li>由于主路由和旁路由设置大部分步骤都完全一样，所以下面以主路由为例，需要设置旁路由的时候会单独说明。</li><li>以下演示的硬件设备为搭载 Intel 12 代 N100 CPU，板载双 2.5G 网口的机器。</li></ul><h2 id="前提条件" tabindex="-1">前提条件 <a class="header-anchor" href="#前提条件" aria-label="Permalink to &quot;前提条件&quot;">​</a></h2><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_22-33-53.webp" alt=""></p><p>硬件直通功能需要使用支持 CPU 虚拟化的平台，并且需要开启 IOMMU，包括主板 BIOS 和内核启动参数两部分。飞牛默认内核启动参数没有开启 IOMMU，需要手动开启。</p><p>BIOS 设置部分，不同的主板可能有所不同，可以自行查询对应的主板开启。常见的 NAS 主板（比如畅网/倍控/铭微的 N5105/N100/8505 等）BIOS 默认 IOMMU 已经开启，无需额外设置 BIOS。</p><p>下面以 Intel 平台为例，介绍设置内核启动参数开启 IOMMU。</p><h3 id="开启-iommu" tabindex="-1">开启 IOMMU <a class="header-anchor" href="#开启-iommu" aria-label="Permalink to &quot;开启 IOMMU&quot;">​</a></h3><p>首先 <a href="/fnos/ssh.html">使用 SSH 登录</a> fnOS，并且换到 <code>root</code> 用户。按照下面的步骤开启 IOMMU。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编辑 grub 配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/default/grub</span></span></code></pre></div><p>在 <code>GRUB_CMDLINE_LINUX_DEFAULT</code> 中加入 <code>intel_iommu=on</code> 参数，注意前后都要保留一个空格。之后按 <code>Ctrl+X</code> 保存，输入 <code>Y</code> 回车确认退出。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_22-38-09.webp" alt=""></p><p>更新 <code>grub</code>，之后重启。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 更新 grub</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update-grub</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reboot</span></span></code></pre></div><p>IOMMU 开启成功之后，在飞牛中会显示 <code>已开启</code>，最后按提示开启 <code>硬件直通选项</code>。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_22-58-21.webp" alt=""></p><h3 id="开启虚拟交换机-ovs" tabindex="-1">开启虚拟交换机（OVS） <a class="header-anchor" href="#开启虚拟交换机-ovs" aria-label="Permalink to &quot;开启虚拟交换机（OVS）&quot;">​</a></h3><p>在网络设置中，开启虚拟交换机。在设置之前，最好将飞牛的网口设置为静态 IP。</p><p>这里是有两个网口，一个是 <code>网口 1</code>，对应的网卡名称是 <code>enp2s0</code>。另一个是 <code>网口 2</code>，对应的网卡名称是 <code>enp3s0</code>。</p><p>目前飞牛使用的网卡是 <code>enp2s0</code>，状态是 <code>已连接</code>，我们需要在这个网卡右边点击•••，选择 <code>启用 OVS</code>。这个网口在 iStoreOS 虚拟机中会作为软路由的 <code>LAN</code> 口。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-16-51.webp" alt=""></p><p>另一个网口 <code>enp3s0</code>，状态是 <code>未连接</code>，待会需要直通给 iStoreOS 虚拟机作为软路由的 <code>WAN</code> 口。</p><h3 id="iso-镜像" tabindex="-1">ISO 镜像 <a class="header-anchor" href="#iso-镜像" aria-label="Permalink to &quot;ISO 镜像&quot;">​</a></h3><p>目前飞牛只支持使用 ISO 镜像作为启动镜像，但是 iStoreOS 提供的镜像是 <code>img</code> 格式。我尝试了各种将 <code>img</code> 转换为 <code>iso</code> 的办法，都有问题。最后还是用 PE ISO 镜像启动，在 PE 中使用 <code>img 写盘工具</code> 将 <code>img</code> 镜像写入到虚拟硬盘中，最后才顺利启动。</p><p>如果你想自己制作 ISO 镜像，这里简述一下大致步骤：</p><ul><li>准备好 PE 的 ISO 镜像，iStoreOS 的 img 镜像，img 写盘工具，UltraISO 镜像编辑工具。</li><li>使用 UltraISO 将 iStoreOS 的 img 镜像，img 写盘工具打包到 PE 的 ISO 镜像中。</li></ul><p>最终得到的可启动的 ISO 文件。你可以从 <a href="https://pan.quark.cn/s/721826545f76" target="_blank" rel="noreferrer">夸克网盘下载</a>。</p><p>之后在飞牛中建立一个 <code>iso</code> 文件夹，把 ISO 镜像上传到这个文件夹里。</p><h2 id="创建虚拟机" tabindex="-1">创建虚拟机 <a class="header-anchor" href="#创建虚拟机" aria-label="Permalink to &quot;创建虚拟机&quot;">​</a></h2><p>经过以上步骤，终于可以开始建立 iStoreOS 的虚拟机了，按照下面的步骤来操作：</p><p>虚拟机名称 <code>iStoreOS</code>，操作系统选择 <code>Linux</code>，版本 <code>6.x - 2.6 Kernel</code>。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_22-59-43.webp" alt=""></p><p>启动镜像选择我们上传的 ISO 文件，其它按图所示。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-12-55.webp" alt=""></p><p>添加存储空间，分配大小为 4G 的 <code>SATA</code> 类型的虚拟硬盘，用来将 img 镜像写入到这个虚拟硬盘里。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-14-52.webp" alt=""></p><p>在之前我们创建好了虚拟交换机，这里就会自动把虚拟网卡加到虚拟机里，保持默认。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-20-17.webp" alt=""></p><div class="tip custom-block"><p class="custom-block-title">提示</p><p>硬件直通这一步，如果是做主路由，需要添加硬件（直通网卡），如果是做旁路由，则不需要添加硬件，直接点击 <code>创建</code>。</p></div><p>这一步需要添加之前那个未被使用的网卡，也就是 enp3s0，该网卡在 PCIE 中的设备地址为：<code>03:00.0</code>，点击 <code>添加硬件</code>，按提示添加。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-21-42.webp" alt=""></p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-22-43.webp" alt=""></p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-21_23-22-57.webp" alt=""></p><p>创建完成之后，启动虚拟机，并使用自带的 VNC 访问虚拟机。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-15-29.webp" alt=""></p><h2 id="写入-img-镜像到虚拟磁盘" tabindex="-1">写入 img 镜像到虚拟磁盘 <a class="header-anchor" href="#写入-img-镜像到虚拟磁盘" aria-label="Permalink to &quot;写入 img 镜像到虚拟磁盘&quot;">​</a></h2><p>虚拟机开机之后，自动启动 PE，打开 <code>此电脑</code>，按下图位置定位到 iStoreOS 文件夹。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-16-27.webp" alt=""></p><p>打开 <code>img 写盘工具</code>，<code>映像档</code> 选择 <code>istoreos.img</code> 文件，点击 <code>开始</code>。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-17-00.webp" alt=""></p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_11-51-12.webp" alt=""></p><p>写入完成之后，关闭虚拟机。之后编辑虚拟机，删除启动镜像，点击确定。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-18-33.webp" alt=""></p><p>再次启动虚拟机，就会从虚拟硬盘中的 iStoreOS 启动。</p><p><img src="https://img.slarker.me/wiki/Snipaste_2025-01-22_14-19-25.webp" alt=""></p><p>后续 iStoreOS 路由模式设置可以参考这里：<a href="/istoreos/route_setting.html">iStoreOS 路由模式设置</a>。</p>`,60)]))}const g=i(p,[["render",o]]);export{h as __pageData,g as default};
